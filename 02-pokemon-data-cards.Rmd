# card data

## read raw

using `sheet_names2` vector (which does not necessarily match the series names provided by Bulbapedia), read the excels.
```{r}
raw_xlsx <- 
  map(
    sheet_names2,
    ~ read_xlsx(
      excel_path,
      sheet = .x,
      skip = 3,
      col_types = "text"
    )
  ) 
```

## convert to df

`raw_xlsx` is still a list. Convert it to df: 

```{r}
pokemon_df_list <- 
  map2(
    .x = raw_xlsx,
    .y = sheet_names2,
    ~ mutate(.data = .x, series = rep(.y, nrow(.x)))
  ) |> 
  map(
    ~ mutate(
      .data = .x,
      `Set #` = `Set #` |> as.character() # some are num, some are char
    )
  )
# bind rows
everything_df_raw <- 
  pokemon_df_list |> 
  bind_rows() |> 
  filter(!is.na(Type)) |> # remove empty rows
  select(`Set #`, Name, Type, series)
```

## Match series names to Bulbapedia

```{r}
everything_df_bulbanized <- 
  everything_df_raw |> 
  mutate(
    series = recode(
      series,
      `McDonalds Collection 2021` = "McDonald's Collection 2021",
      `Champions Path` = "Champion's Path",
      `Sword and Shield` = "Sword & Shield",
      `Sword and Shield Promos` = "SWSH Black Star Promos",
      `Sun and Moon` = "Sun & Moon",
      `Sun and Moon Promos` = "SM Black Star Promos",
      `Mcdonalds Collection 2015` = "McDonald's Collection 2015",
      `Mcdonalds Collection 2014` = "McDonald's Collection 2014",
      `McDonalds Collection 2012` = "McDonald's Collection 2012", # not Mcd!
      `X and Y` = "XY",
      `X and Y Promos` = "XY Black Star Promos",
      `McDonalds Collection` = "McDonald's Collection",
      `Black and White` = "Black & White", 
      `HeartGold and SoulSilver` = "HeartGold & SoulSilver",
      `Pokemon GO` = "Pokémon GO"

    ),
    series = str_replace(series, "Pop", "POP")
  )
```

## Merge series df & poke df

Now that the series names are Bulbanized, merge these datasets to retrieve `series_type` and `release_date` and  `series_gen`:

```{r}
df_series_en <- df_series |> select(!ends_with("_ja"))
everything_df_merged <-
  left_join(
    everything_df_bulbanized,
    df_series_en,
    by = c("series")
  ) 
everything_df_merged # 15029 x 11
```

## fix typos in Type

"Fightning", "Coloress" etc.

```{r}
everything_df_merged |> dim() # 15029 x 10
```


```{r}
# check typos

pokemon_df_summarised <- everything_df_merged |> 
  group_by(Type) |> 
  summarise(n = n()) |> 
  arrange(n |> desc())
everything_df_raw$Type |> unique()
```

```{r}
everything_df_typo <- everything_df_merged |> 
  mutate(
    Type = recode(Type, 
      Fightning = "Fighting",
      FIGHting = "Fighting",
      Coloress = "Colorless",
      Colorelss = "Colorless",
      Normal = "Colorless",
      Electric = "Lightning",
      Lightnijg = "Lightning",
      Lighting = "Lightning"
    ),
    Name = 
      str_replace(
        Name, "\\s+", " "
      ) |> # Garados* δ EX Holon Phantoms 102/110 includes two spaces :(
      str_replace("Dartix", "Dartrix") |> 
      str_replace("\\sForm\\s", " Forme ") |> 
      str_replace("Melmetal\\sV", "MelmetalV") |> 
      str_replace("Exeggutor\\sV", "ExeggutorV") |> 
      str_replace("Hatternee", "Hatterene") |> 
      str_replace("Primal KyogreEK", "Primal KyogreEX") |> 
      str_replace("StaraptorFCLV.X", "StaraptorFBLV.X") |>
      str_replace("Sirfetch’d", "Sirfetch'd") |> 
      str_replace("Castform\\sRain\\s", "Castform Rainy\\s"), # TODO: move this to df typo
    Type = if_else(Name == "Morty", "Supporter", Type), # one of the two Morty incorrectly classified as "Psychic"
  )

types_non_pokemon <-  c("Trainer", "Energy", "Supporter", "Item", "Stadium", "Tool", "TM")
pokemon_type_ranking <- everything_df_typo |>
  filter(!Type %in% types_non_pokemon) |> 
  group_by(Type) |> 
  summarise(n = n()) |> 
  arrange(desc(n))
major_types <- pokemon_type_ranking |> 
  filter(n > 100) |> # omit type+type pokemons
  select(Type) |> 
  pull()
mixed_types <- pokemon_type_ranking |> 
  filter(n <= 100) |> # select type+type pokemons
  select(Type) |> 
  pull()
```

## color the types

[kawaii](https://pokepalettes.com/)
[palettetown and pokepal](https://github.com/timcdlucas/palettetown) not so much helpful here
[r base color sucks](https://bookdown.org/hneth/ds4psy/D-3-apx-colors-basics.html)
[manually pick colour](https://codepen.io/HunorMarton/details/eWvewo)


```{r}
everything_df_coloured <- everything_df_typo |> 
  mutate(
    colour = recode(
      Type, 
      Water = "#80DDFF",
      Grass = "#80FF82",
      Psychic = "#361C63",
      Colorless = "#D1D1D1",
      Fighting = "#8F441E",
      Fire = "#FF0F23",
      Lightning = "#F0C800",
      Darkness = "#1D1D1B", # black
      Metal = "#463F43", # silver
      Dragon = "#ABAD00", # gold
      Fairy = "#FF4DAF", # purple
    ),
    Type2 = case_when(
      Type %in% mixed_types ~ "mixed",
      TRUE ~ Type),
    is_pokemon = !Type %in% types_non_pokemon | Name != "Buried Fossil" # tricky edge case: Buried Fossil is not a pokemon but Colorless item that can be used like a pokemon.
  ) 

```

*colours*

```{r}
colours_named_vector <- 
  c("Water" = "#80DDFF",
      "Grass"= "#80FF82",
      "Psychic" = "#361C63",
      "Colorless" = "#D1D1D1",
      "Fighting" = "#8F441E",
      "Fire" = "#FF0F23",
      "Lightning" = "#F0C800",
      "Darkness" = "#1D1D1B", # black
      "Metal" = "#463F43", # silver
      "Dragon" = "#ABAD00", # gold
      "Fairy" = "#FF4DAF", # purple
      "mixed" = "black"
    )
```

## repair set numbers that are converted to Dates

test

```{r}
# check problems
"2022-04-22" |> 
  ymd() %>% # default pipe does not support {} in RHS
  {str_c(month(.), "/", day(.))}
# pop series 9 1/17 Garchomp
"44213.0" |> 
  as.numeric() |> 
  as.Date(origin = "1899/12/30") %>% # excel date starts from 12/30
  {str_c(month(.), "/", day(.))}
```

regex: [Rdrr](https://rdrr.io/cran/stringi/man/about_search_regex.html)

```{r}
everything_df_date <- everything_df_coloured |> 
  # filter(series %in% c("EX Trainer Kit 2", "Pop Series 9")) |>
  mutate(
    set = 
      case_when(
        str_detect(
          `Set #`,
          pattern = "\\d{4}-\\d{2}-\\d{2}"
        ) ~
        # use {} to use dot operator more than once,
        # and use %>% instead of base |> to do so. base pipe doesn't support it
        ymd(`Set #`) %>%
          {str_c(month(.), "/", day(.))}, # 11086 failed to parse
        str_detect(
          `Set #`,
          pattern = "\\d{5}.0"
        ) ~
        as.character(`Set #`) |> 
          as.numeric() |>
          as.Date(origin = "1899/12/30") %>%
          {str_c(month(.), "/", day(.))}, # NAs introduced by coersion
        TRUE ~ `Set #`
      )
  ) |> 
  select(set, everything(), -`Set #`)
everything_df_date
```
Ignore the warnings. Idk why it warns me that.

## card number, promo or not

[regex stringr](https://stringr.tidyverse.org/articles/regular-expressions)
[cheat sheet](https://evoldyn.gitlab.io/evomics-2018/ref-sheets/R_strings.pdf) look arounds
```{r}
# https://stackoverflow.com/questions/6109882/regex-match-all-characters-between-two-strings
# str_view_all("BH233/BH244", "(?<=[:alpha:]{0,8})\\d+(?=/)")
# str_view_all("50a/147", "(?<=[:alpha:]{0,8})\\d+(?=[:lower:]{0,1}/)")

everything_df_card_no <- everything_df_date |> 
  mutate(
    card_number = 
      case_when(
        str_detect(set, ".?/.?") ~
          str_extract(
            set, 
            "(?<=[:alpha:]{0,3})\\d+(?=[:lower:]{0,1}/)"
          ) |> 
          as.integer(),
        str_detect(set, "\\d+") ~
          str_extract(set, "\\d+") |> as.integer(),
        str_detect(set, "\\d+$") ~
          str_extract(set, "\\d+$") |> as.integer(),
        # str_detect(set, "[A-Z]+\\d+") ~
        #   str_extract(set, "\\d")
        TRUE ~ NA_integer_
      ),
    cards_total_official = 
      if_else(
        str_detect(set, ".?/.?"),
        str_extract(
          set,
          "(?<=/[:alpha:]{0,3})\\d+"
        ) |> 
        as.integer(),
        NA_integer_
      ),
    is_secret_card =  (card_number > cards_total_official), # !is.na(card_total) &&
    release_date = as_date(release_date) # POSIXct to Date
  )
everything_df_card_no2 <- 
  everything_df_card_no |> 
  select(
    Name, 
    series_gen, 
    series, 
    release_date, 
    set, 
    card_number, 
    cards_total_official, 
    starts_with("is_"),  
    everything()
  ) 
everything_df_card_no2
```
## count of data points

Add a row to df that counts up the number of actual data points of pokemon cards available in the dataset [#4](https://github.com/xerroxcopy/pokemon-tcg/issues/4)
```{r}
summarise_df_count_cards <- 
  everything_df_card_no2 |> 
  filter(is_pokemon) |> # count only pokemons
  group_by(series) |> 
  summarise(pokemon_data_count = n())
summarise_df_count_cards
df_series2 <- df_series |> 
  left_join(summarise_df_count_cards, by = "series") |> 
  select(series_class:cards_total, pokemon_data_count, everything())
```

## name the final df df

```{r}
df <- everything_df_card_no2
```

wrangle the `df` further in `pokemon-genes.Rmd` next. `df` to `df_genes`.
## columns 
```{r}
df |> colnames() |> paste0(collapse = "|\n")
df$series_class|> unique()
df |> 
  filter(series == "Pokémon GO")
```

|column|meaning|
|---|---|
|`Name`|name from V3.25, fixed typo.|
|`series_gen`|generation of the series according to V3.25|
|`series`|name of the series. the names are aligned to that on bulbapedia.|
|`release_date`|release date of the series according to bulbapedia (except `Trainer Kit`s, which are based on V3.25). date, not POSIXct. |
|`set`|`Set #` in V3.25. `chr`|
|`card_number`|card number of `set`, `int`. `12` if `GH12/GH124`, `123` if `AB123`.|
|`cards_total_official`|official total number of cards, excluding secret cards. `int`. Available only if the card number is stylized as a fraction, e.g., `GH12/GH124`.|
|`is_pokemon`|`TRUE` if pokemon. `Buried Fossil` is `FALSE` though it has a `Type` of `Colorless`.|
|`is_secret_card`|`TRUE` if `card_number` of that card exceeds `cards_total_official`.|
|`Type`|type of the card, `df$Type |> unique()` `Lightning`, `Tool`, `Metal/Fighting`, etc. Some typos are fixed.|
|`series_class`|from `df_series`, `Black Star Promo`, `Main Expansion`, `Special Expansions`, `Trainer Kit`, `Pop Series`, and `McDonalds Collection`. classified based on bulbapedia.|
|`cards_total`|the total count of the cards, according to Bulbapedia. Doesn't necessarily match the number of cards listed in `df`, since the spreadsheet may be incomplete.|
|`series_abb`|abbreviation on Bulbapedia.|
|`meta_is_bulba_only`|metadata: `TRUE` if the series is available on Bulbapedia. in `df` this is all `FALSE`.|
|`meta_is_v325_only`|metadata: `TRUE` if the series is available on spreadsheet but not on the series list of Bulbapedia. `TRUE`: `Trainer Kit`s, `FALSE` everything else.|
|`colour`||
|`Type2`|simplified `Type`s.|
