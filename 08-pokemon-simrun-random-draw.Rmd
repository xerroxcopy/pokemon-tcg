# random draw

ここでの目的は、株式会社ポケモンのデザイナーの思考パターンをランダムでどこまで模せるかを調べること。そのためにはいくつかのpresumptionが必要になる。まず、あるタイムステップ（具体的には`release_date`のどこか）`t = t_n`で、すでにリリースされているポケモンのゲーム・すでに公開されているポケモンのリストがあるとする。`t_n`においてリリースする枚数は興味がないので、すでに決定しているとする（`release_date`における`total_cards`に相当する）。そのとき、デザイナーは次のように適当にポケモンを選ぶことが考えられる：

1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を許す。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複をなるべく避ける（その回にすでにひいたポケモンにネガティブなバイアスがかかる）。毎回のリリースで偏りが生じる。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を好む（すでにひいたポケモンにポジティブなバイアスがかかる）
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、そのとき`t_n`が最も最近（頭痛が痛い…）の`game_release_date`に近い場合、新しく追加されたポケモンを好んで選ぶ（新しいポケモンの発表直後はどうも多くリリースされているように見えるので）。pro-noveltyな変異 bias.
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、Generation Iの151匹から好んで選ぶ。第1世代へポジティブなバイアス。やっぱり人気だから…イーブイとかピカチュウとか…。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶするのだが、今までのリリースで多く選ばれたものを好んで選ぶ。正の頻度依存変異バイアス。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶするのだが、前回のリリースで選ばれたポケモンを好んで選ぶ。伝達バイアス。

これだけあればとりあえず十分かと・・・。まず１だけ実装してみよう。
nested dfでやるかmatrixでやるかはたまたdfでやるか。毎回population_sizeが違うのでnested dfがいいのかな


```{r}
series_gen_df3 <- series_gen_df2 |> 
  left_join(df_game_gen |> select(game_gen, pokemon_cumulative_n), by = "game_gen") |> 
  filter(!is.na(pokemon_data_count))
# series_gen_df3
```
[Unnest a list of vectors in a data frame in R](https://stackoverflow.com/questions/66819613/unnest-a-list-of-vectors-in-a-data-frame-in-r)
```{r}

sim_random_df <- tibble(
  series_gen = integer(),
  series = character(),
  release_date = Date(),
  cards_total = integer(),
  pokemon_data_count = integer(),
  game_gen = integer(),
  pokemon_cumulative_n = integer(),
  pokedex_id = integer(), 
  run = integer()
)
simulation_runs <- 1000

for (simulation_run in 1:simulation_runs) {
  single_sim_result_df <- series_gen_df3 |>
  mutate(
    pokedex_id =  map2( # rowwise() does not work...?
      .x = pokemon_data_count,
      .y = pokemon_cumulative_n,
      ~ runif(
        n = .x,
        min = 1,
        max = .y + 1
      ) |> floor()
    ),
    run = rep(simulation_run, nrow(series_gen_df3))
  ) |> 
  unnest_longer(pokedex_id)
  sim_random_df <- bind_rows(sim_random_df, single_sim_result_df)
} #  7min? for 1000 runs
sim_random_df |> dim() # 1 2325 000 x 9
```


## compare gen histogram 

### count
```{r}
df_empirical_count_id <- 
  df_gene |> 
  filter(is_pokemon) |> # filter only pokemons. is_
  group_by(pokedex_id) |> 
  summarise(n = n()) %>% 
  mutate(
    condition = rep("empirical", nrow(.))
  )
sim_random_count_pokemon_df <- 
  sim_random_df |> 
  # left_join(df_names, by = "id") |> 
  group_by(pokedex_id, run) |> 
  summarise(n = n()) |> 
  ungroup() %>%
  mutate(
    condition = rep("simulation", nrow(.))
  ) 


```
### merge

```{r}
emp_sim_count_id_df <- 
  bind_rows(
    df_empirical_count_id, 
    sim_random_count_pokemon_df
  ) |> 
  left_join(df_names, by = "pokedex_id")
emp_sim_count_id_df |> colnames()
```

### plot the sim~emp difference

SDを準備
```{r}
emp_sim_count_id_summary_df <- emp_sim_count_id_df |> 
  group_by(condition, pokemon_gen) |> 
  summarise(
    mean = mean(n),
    sd = sd(n)
  )
```
annotation用のdfを用意
```{r}
emp_sim_count_id_annotate_df <-
  emp_sim_count_id_df |>
  filter(condition == "empirical") |> 
  group_by(pokemon_gen) |> 
  # arrange(desc(n)) |>
  # slice_max(order_by = n, n = 1)

  filter(n == max(n) | n > 70)
```
これ↓を掲載予定

```{r}
# p_emp_sim_count_id <- 
  emp_sim_count_id_df |> 
  # filter(is.na(run) | run == 1) |> 
  ggplot(aes(x = pokemon_gen, y = n, fill = condition)) +
  geom_quasirandom(
    pch = 21,
    size = .6,
    # alpha = .3,
    dodge.width = .8,
    stroke = 0
    ) +
  geom_pointrange(
    data = emp_sim_count_id_summary_df, 
    aes(x = pokemon_gen, y = mean, ymin = mean-sd, ymax = mean+sd),
    position = position_dodge(.8),
    colour = "white",
    fatten = .1,
    stroke = 1,
    size = .2
  ) + 
  # geom_point(
  #   data = emp_sim_count_id_annotate_df,
  #   aes(x = pokemon_gen - .8/4),
  #   colour = "#d44215",
  #   size = .7,
  #   stroke = 0
  # ) +
    # pikachu annotation
  # geom_text(
  #   data = emp_sim_count_id_annotate_df,
  #   aes(label = name, x= pokemon_gen - .125), # position_dodge / 4?
  #   hjust = .5,
  #   vjust = 0,
  #   nudge_y = 2,
  #   size = 2,
  #   family = "Fira Code"
  # ) +
  # scale_alpha_manual(values = c("simulation" = 1, "empirical" = 1), guide = "none") +
  scale_fill_manual(values= c("simulation" = "grey20", "empirical" = "orange")) +
  # scale_colour_manual(values = c("simulation" = "white", "empirical" = "#d44215"), guide = "none") +
  scale_x_continuous(
    breaks = 1:8,
    labels = 1:8 |> as.roman(),
    name = "Pokémon Generation"
  ) +
  scale_y_continuous(
    limits = c(0, 85), # ignore pikachu!
    breaks = c(0, 40, 80),
    
    # expand = c(1, NA),
    name = "No. of Pokémon Cards",
    # trans = "log10"
  ) +
  

  # geom_point(data = df_empirical_count_id, size = 1, alpha = .5, colour = "orange") +
  theme_pokemon +
  theme(
    legend.position = c(.8, .7)
  )
# ggsave("./output/emp_sim_count_id.png", width = 83, height = 35, unit = "mm", dpi = 600)
ggsave("./output/emp_sim_count_id.svg", width = 83, height = 45, unit = "mm", dpi = 600)
p_emp_sim_count_id

```

Caption:


というかEeveeが2位だと思ってたのだがCharizard?pokemon_nameとcard_nameでだいぶ違うのだろう。Charizardという名前card_nameでは少ないけど、Charizardというポケモンpokemon_nameでは多いということ。つまりEeveeよりもリミックスされがちだということだ！
リミックス度が測れるな　横軸がポケモンの数、縦軸がVariationの数的な


#### variations (ignore)

まずは全部のIDについてテスト
```{r}
sim_random_count_pokemon_df |> 
  filter(run < 10) |> 
  ggplot(aes(x = pokedex_id, y = n)) +
  geom_jitter(alpha = .1, size = .2, colour = "grey40") +
  geom_point(data = df_empirical_count_id, size = 1, alpha = .5, colour = "orange") +
  theme_pokemon
ggsave("./output/count_emp_vs_sim_total_individual_ID.png", width = 83, height = 35, unit = "mm", dpi = 600)

```

世代ごとにまとめてquasirandom

```{r}
emp_sim_count_id_df |> 
  # filter(condition == "simulation") |> 
  ggplot(aes(x = pokemon_gen, y = n,)) +
  geom_quasirandom(
    size = .2,
    alpha = .3,
    colour = "grey70"
    ) +
  geom_quasirandom(
    data = emp_sim_count_id_df |> 
             filter(condition == "empirical"),
    varwidth = TRUE,
    size = .2,
    colour = "red"
  ) +
  scale_x_continuous(breaks = 1:8) +
  # geom_point(data = df_empirical_count_id, size = 1, alpha = .5, colour = "orange") +
  theme_pokemon
ggsave("./output/count_emp_vs_sim_total.png", width = 83, height = 35, unit = "mm", dpi = 600)
```




