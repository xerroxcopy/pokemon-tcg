# random draw

```{r}
df_series |> 
  colnames()
```

```{r}
game_gen_df <- 
  tribble(
    ~game_gen, ~game_release_date, ~game_release_date_ja, ~pokemon_n_new,
    1,         "1998-09-28",   "1996-02-27", 151,
    2,         "2000-10-15",   "1999-11-21", 100,
    3,         "2003-03-15",   "2002-11-21", 135, # https://bulbapedia.bulbagarden.net/wiki/Generation_III
    4,         "2007-04-22",   "2006-09-28", 107, # https://bulbapedia.bulbagarden.net/wiki/Generation_IV
    5,         "2011-03-04",   "2010-09-18", 156, 
    6,         "2013-10-12",   "2013-10-12", 72,
    7,         "2016-11-18",   "2016-11-18", 88, # 81+5+2=88
    8,         "2019-11-15",   "2019-11-15", 96, # 89+7
    9,         "2022-11-18",   "2022-11-18", NA_integer_
    ) |> 
  mutate(
    across(starts_with("game_release"), as.Date),
    game_end_date = lead(game_release_date),
    pokemon_cumulative_n = cumsum(pokemon_n_new)
  )
game_gen_df
# game_gen_df |> filter(game_gen == 1) |> extract("release_date") |> pull()
```


```{r}
series_gen_df <- df_series |> 
  select(series_gen, series, release_date, cards_total)
series_gen_df2 <- map_dfr(
  .x = 1:8, 
  ~ mutate(
    .data = series_gen_df, 
    game_gen = 
      case_when(
        release_date < game_gen_df |> filter(game_gen == .x+1) |> extract("game_release_date") |> pull() 
        ~ .x
      ),
    # game_gen_ja = 
    #   case_when(
    #     release_date < game_gen_df |> filter(game_gen == .x+1) |> extract("release_date_ja") |> pull() 
    #     ~ .x
    #   )
    ) |> filter(!is.na(game_gen))
  ) 
```

Neo Genesisは[例外的に](https://bulbapedia.bulbagarden.net/wiki/Neo_Genesis_(TCG))速いが、他は基本的に新世代の発表からちょっと遅れて？登場してそう


```{r}
df_gene |> 
  ggplot(aes(x = release_date, y = id, colour = pokemon_gen)) +
    geom_rect(
    data = game_gen_df |> filter(game_gen != 9),
    aes(xmin = game_release_date, xmax = game_end_date, fill = game_gen |> as.factor()),
    ymin = -Inf, ymax = Inf, 
    inherit.aes = FALSE,
    alpha = .5
  ) +
  geom_count(alpha = .3,  stroke = .1) +
  geom_count(data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  scale_colour_viridis_c(option = "C") +
  # scale_fill_viridis_c() +
  scale_fill_viridis_d(option = "C") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
ggsave("./output/blackstar-promo-release-date-problem.png", width = 3000, height = 2000, unit = "px")
```

"Black Star Promo"がおかしいことがわかる。

```{r}
df_gene |> 
  # filter(series_class != "Main Expansion") |> 
  ggplot(aes(x = release_date, y = id, colour = pokemon_gen)) +
    geom_rect(
    data = game_gen_df |> filter(game_gen != 9),
    aes(xmin = game_release_date, xmax = game_end_date, fill = game_gen |> as.factor()),
    ymin = -Inf, ymax = Inf, 
    inherit.aes = FALSE,
    alpha = .5
  ) +
  geom_count(alpha = .3,  stroke = .1) +
  # geom_count(data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  scale_colour_viridis_c(option = "D") +
  scale_size_area() +
  # scale_fill_viridis_c() +
  scale_fill_viridis_d(option = "C") +
  theme_minimal() +
  facet_wrap(vars(series_class)) +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
ggsave("./output/series_class-t.png", width = 3000, height = 2000, unit = "px")


```


Generationをrectじゃなくて線にしてみましょう
```{r}
df_gene |> 
  ggplot(aes(x = release_date, y = id)) +
  geom_vline(
    data = game_gen_df |> filter(game_gen != 9),
    aes(xintercept = game_release_date, colour = game_gen |> as.factor()),
    linetype = "dashed"
  ) +
  geom_text(
    data = game_gen_df |> filter(game_gen != 9),
    aes(label =as.roman(game_gen), x = game_release_date, colour = game_gen |> as.factor()),
    y = -10,
    size = 2,
    hjust = 0,
    vjust = 1,
    nudge_x = 100,
    # nudge_y = -1000
  ) +
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .3,  stroke = .1) +
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .5, data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  # scale_colour_viridis_d(option = "C") +
  scale_fill_viridis_c() +
  scale_colour_viridis_d(option = "D") +
  scale_y_continuous(limits = c(0, NA)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
ggsave("./output/blackstar-promo-release-date-problem.png", width = 3000, height = 2000, unit = "px")
```
とりあえず問題があることはわかったものの治さずともとりあえずランダムドローはできるのでやってみる。

## Random draw

ここでの目的は、株式会社ポケモンのデザイナーの思考パターンをランダムでどこまで模せるかを調べること。そのためにはいくつかのpresumptionが必要になる。まず、あるタイムステップ（具体的には`release_date`のどこか）`t = t_n`で、すでにリリースされているポケモンのゲーム・すでに公開されているポケモンのリストがあるとする。`t_n`においてリリースする枚数は興味がないので、すでに決定しているとする（`release_date`における`total_cards`に相当する）。そのとき、デザイナーは次のように適当にポケモンを選ぶことが考えられる：

1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を許す。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複をなるべく避ける（その回にすでにひいたポケモンにネガティブなバイアスがかかる）。毎回のリリースで偏りが生じる。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を好む（すでにひいたポケモンにポジティブなバイアスがかかる）
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、そのとき`t_n`が最も最近（頭痛が痛い…）の`game_release_date`に近い場合、新しく追加されたポケモンを好んで選ぶ（新しいポケモンの発表直後はどうも多くリリースされているように見えるので）。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、Generation Iの151匹から好んで選ぶ。第1世代へポジティブなバイアス。やっぱり人気だから…イーブイとかピカチュウとか…。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶするのだが、今までのリリースで多く選ばれたものを好んで選ぶ。正の頻度依存バイアス。

これだけあればとりあえず十分かと・・・。まず１だけ実装してみよう。
nested dfでやるかmatrixでやるかはたまたdfでやるか。毎回population_sizeが違うのでnested dfがいいのかな
```{r}
series_gen_df3 <- series_gen_df2 |> 
  left_join(game_gen_df |> select(game_gen, pokemon_cumulative_n), by = "game_gen")
series_gen_df3
```
`"Base Set 2"`の130枚を493枚から選ぶには：
```{r}
runif(
  n = 210,
  min = 1,
  max =350 + 1
  ) |> 
floor()


random_draw_df1 <- series_gen_df3 |>
  filter(!is.na(cards_total)) |> 
  # rowwise() |>
  mutate(
    random_draw = 
      runif(
        n = cards_total,
        min = 1,
        max = pokemon_cumulative_n + 1
        ) |> 
      floor()
  )
random_draw_df1 |> str()
random_draw_df1$random_draw[1]
```


```{r}
series_gen_df4 <- 
  series_gen_df3 |> 
  filter(!is.na(cards_total))

map2(
  .x = series_gen_df4$cards_total,
  .y = series_gen_df4$pokemon_cumulative_n,
  ~ runif(
    n = .x,
    min = 1,
    max = .y + 1
  ) |> floor()
) 
```

