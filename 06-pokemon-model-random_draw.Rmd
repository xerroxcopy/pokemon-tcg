# random draw

```{r}
df_series |> 
  colnames()
```

## Random draw

ここでの目的は、株式会社ポケモンのデザイナーの思考パターンをランダムでどこまで模せるかを調べること。そのためにはいくつかのpresumptionが必要になる。まず、あるタイムステップ（具体的には`release_date`のどこか）`t = t_n`で、すでにリリースされているポケモンのゲーム・すでに公開されているポケモンのリストがあるとする。`t_n`においてリリースする枚数は興味がないので、すでに決定しているとする（`release_date`における`total_cards`に相当する）。そのとき、デザイナーは次のように適当にポケモンを選ぶことが考えられる：

1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を許す。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複をなるべく避ける（その回にすでにひいたポケモンにネガティブなバイアスがかかる）。毎回のリリースで偏りが生じる。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を好む（すでにひいたポケモンにポジティブなバイアスがかかる）
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、そのとき`t_n`が最も最近（頭痛が痛い…）の`game_release_date`に近い場合、新しく追加されたポケモンを好んで選ぶ（新しいポケモンの発表直後はどうも多くリリースされているように見えるので）。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、Generation Iの151匹から好んで選ぶ。第1世代へポジティブなバイアス。やっぱり人気だから…イーブイとかピカチュウとか…。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶするのだが、今までのリリースで多く選ばれたものを好んで選ぶ。正の頻度依存バイアス。

これだけあればとりあえず十分かと・・・。まず１だけ実装してみよう。
nested dfでやるかmatrixでやるかはたまたdfでやるか。毎回population_sizeが違うのでnested dfがいいのかな


```{r}
series_gen_df3 <- series_gen_df2 |> 
  left_join(df_game_gen |> select(game_gen, pokemon_cumulative_n), by = "game_gen") |> 
  filter(!is.na(pokemon_data_count))
# series_gen_df3
```
[Unnest a list of vectors in a data frame in R](https://stackoverflow.com/questions/66819613/unnest-a-list-of-vectors-in-a-data-frame-in-r)
```{r}

sim_random_df <- tibble(
  series_gen = integer(),
  series = character(),
  release_date = Date(),
  cards_total = integer(),
  pokemon_data_count = integer(),
  game_gen = integer(),
  pokemon_cumulative_n = integer(),
  id = integer(), 
  run = integer()
)
simulation_runs <- 1000

for (simulation_run in 1:simulation_runs) {
  single_sim_result_df <- series_gen_df3 |>
  mutate(
    id =  map2( # rowwise() does not work...?
      .x = pokemon_data_count,
      .y = pokemon_cumulative_n,
      ~ runif(
        n = .x,
        min = 1,
        max = .y + 1
      ) |> floor()
    ),
    run = rep(simulation_run, nrow(series_gen_df3))
  ) |> 
  unnest_longer(id)
  sim_random_df <- bind_rows(sim_random_df, single_sim_result_df)
} #  5min? for 1000 runs
sim_random_df |> dim() # 15029000 x 9
```


### compare gen histogram 

```{r}
df_empirical_count_id <- 
  df_gene |> 
  filter(!is.na(id)) |> # filter only pokemons. is_
  group_by(id) |> 
  summarise(n = n()) %>% 
  mutate(
    condition = rep("empirical", nrow(.))
  )
sim_random_count_pokemon_df <- 
  sim_random_df |> 
  # left_join(df_names, by = "id") |> 
  group_by(id, run) |> 
  summarise(n = n()) |> 
  ungroup() %>%
  mutate(
    condition = rep("simulation", nrow(.))
  )
sim_random_count_pokemon_df |> 
  filter(run < 10) |> 
  ggplot(aes(x = id, y = n)) +
  geom_jitter(alpha = .1, size = .2, colour = "grey40") +
  geom_vline()
  geom_point(data = df_empirical_count_id, size = 1, alpha = .5, colour = "orange") +
  theme_pokemon
  # scale_colour_viridis_c() +
  # scale_y_continuous(trans=  "log10")
```


## emp pokemon_name vs sim pokemon_name, cumulative, yearly, 5y interval.
```{r}
release_dates <- df_series2 |> 
  filter(!is.na(pokemon_data_count)) |> 
  select(release_date) |> 
  na.omit() |> 
# number_of_releases <- length(release_dates) # 148
release_dates |> min() # 1999 Jan
release_dates |> max()# 2022 Sep
# months_seq <- seq(as.Date("2009-01-01"), length = 166, by = "months")
years_seq <- seq(as.Date("1999-01-01"), length = 25, by = "years") # NOT 2009!!
```

この`release_dates`で`for`を回して、これ以下のデータでフィルタしていく。

### filter dfs until specific year (~2000, ~2014, etc.), merge them

```{r}
sim_random_df # 1000 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 
# initialize
temporal_change_cumulative_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  until_date = Date()
)
# run length(months_seq)
for (i in 2:length(years_seq)) { # start from 2 to skip "until 1999-01-01" which doesn't exist
  sim_random_df_until_threshold_date <-
    sim_random_df |> 
    filter(release_date <= years_seq[i])
  emp_df_until_threshold_date <- df_gene |> 
    filter(!is.na(id)) |> 
    filter(release_date <= years_seq[i])
  
  sim_df <- 
    sim_random_df_until_threshold_date |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_card_type_df <- 
    emp_df_until_threshold_date |> 
    mutate(name_type = paste(Name, Type)) |> 
    group_by(name_type) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-name_type) |> 
    distinct() %>%
    mutate(condition = rep("card name + type", nrow(.)))
  emp_card_df <- 
    emp_df_until_threshold_date |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_until_threshold_date |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_card_type_df, emp_card_df, emp_poke_df) %>%
    mutate(
      until_date = rep(years_seq[i], nrow(.))
    )
  temporal_change_cumulative_df <- bind_rows(temporal_change_cumulative_df, merge_df)
} # 3 sec
temporal_change_cumulative_df |> dim() # 8541 x 5

```


### plot 

論文掲載予定

#### filter: only 5 years interval (2005, 2010, 2015, 2020), focus on sim vs emp

```{r}
emp_vs_sim_temporal_five_years_interval_df <- temporal_change_cumulative_df |> 
  filter(
    condition %in% c("simulations", "pokemon name"),
    until_date %in% ymd(c("2005-01-01", "2010-01-01", "2015-01-01", "2020-01-01"))
    )
```


```{r}
emp_vs_sim_temporal_five_years_interval_df |> 
  # filter(condition == "pokemon name") |> 
  ggplot(aes(x = n,y = ecdf, group = paste(until_date, run), colour = condition, size = condition, fill = until_date |> as.factor())) +
  geom_point(
    aes(alpha = condition, shape = condition),
    # data = emp_vs_sim_temporal_five_years_interval_df |> filter(condition == "simulations"),
    # alpha = .3, 
    # colour = "grey30",
    # size = .15/.751,
    stroke = .1
    ) +
  # geom_point(alpha = 1, size = .15/.751) +
  # geom_point( alpha = 1, size = .1) +
  scale_alpha_manual(values = c("pokemon name" = 1,"simulations" =  .2)) +
  scale_shape_manual(values = c(21, 16)) +
  scale_x_continuous(
     expand = c(0.1,0),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    expand = c(0.1,0),
    trans = "log10", 
    breaks = 10^c(0, -3),
    labels = trans_format("log10", math_format(10^.x))
    ) +
  scale_colour_manual(values = c("black", "grey50")) +
  scale_size_manual(values = c(.5, .3/.751)) +
  # scale_colour_paletteer_c("ggthemes::Blue-Green Sequential", trans = "date") + 
  # scale_fill_paletteer_c("pals::ocean.deep", trans = "date") +
   scale_fill_viridis_d() +
  facet_wrap(
    # rows = vars(condition),
    vars(until_date),
    nrow = 1
  ) +
  theme_pokemon +
  theme(aspect.ratio = 1, 
        legend.position = c(.1, .4))
ggsave("./output/count_emp_vs_sim_temporal_five_years_interval.png", width = 86, height = 35, unit = "mm", dpi = 600)
# ggsave("./output/temporal-change-cumulative.pdf", width = 75, height = 30, unit = "mm")
```
常にSimのほうが急に下がる（肩がとがっている）＝中間層が多い。10とか20とか。

### temporal change, yearly


```{r}
sim_random_df_small # 10 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 

# initialize
temporal_change_yearly_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  year = Date()
)
# run length(months_seq)
for (i in 1:(length(years_seq) - 1)) {
  sim_random_df_small_yearly <-
    sim_random_df_small |> 
    filter(
      release_date <= years_seq[i+1] 
      & 
      release_date > years_seq[i]
    )
  emp_df_yearly <- df_gene |> 
    filter(!is.na(id)) |> 
    filter( 
      release_date <= years_seq[i+1] 
      & 
      release_date > years_seq[i]
    )
  
  sim_df <- 
    sim_random_df_small_yearly |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_long_df <- 
    emp_df_yearly |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_yearly |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_long_df, emp_poke_df) %>%
    mutate(
      year = rep(years_seq[i], nrow(.))
    )
  temporal_change_yearly_df <- bind_rows(temporal_change_yearly_df, merge_df)
    cat(i, ", ")

} # 1min?
temporal_change_yearly_df |> dim() # 885 x 5

```

plot

```{r}
temporal_change_yearly_df |> 
  ggplot(aes(x = n,y = ecdf, group = year, colour = year)) +

  geom_line(alpha = 1, size = .1) +
  geom_point( alpha = 1, size = .1) +
  scale_x_continuous(
    # limits = c(1, 10000),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    # limits = c(0.0001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  scale_colour_viridis_c(trans = "date") + 
  facet_wrap(vars(condition)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/temporal-change-cumulative.png", width = 6000, height = 2000, unit = "px")

```

### temporal change, temporal

```{r}
sim_random_df_small # 10 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 

# initialize
temporal_change_each_release_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  release_date = Date()
)
# run length(months_seq)
for (i in 1:length(release_dates)) {
  sim_random_df_small_each_release <-
    sim_random_df_small |> 
    filter(release_date == release_dates[i])
  emp_df_each_release <- df_gene |> 
    filter(!is.na(id)) |> 
    filter(release_date == release_dates[i])
  
  sim_df <- 
    sim_random_df_small_each_release |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_long_df <- 
    emp_df_each_release |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_each_release |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_long_df, emp_poke_df) %>%
    mutate(
      release_date = rep(release_dates[i], nrow(.))
    )
  cat(i, ", ")
  temporal_change_each_release_df <- bind_rows(temporal_change_each_release_df, merge_df)
} # 1min?
temporal_change_each_release_df |> dim() # 71780 x 5

```

plot

```{r}
temporal_change_each_release_df |> 
  ggplot(aes(x = n,y = ecdf, group = paste(release_date, run), colour = release_date)) +

  geom_line(alpha = 1, size = .1) +
  geom_point( alpha = 1, size = .1) +
  scale_x_continuous(
    # limits = c(1, 10000),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    # limits = c(0.0001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  scale_colour_viridis_c() + 
  facet_wrap(vars(condition)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/temporal-change-each_release.png", width = 6000, height = 2000, unit = "px")

```


### omake: frequency distribution of 1000 runs

```{r}
df_count_pokemon_random_draw <- sim_random_df |> 
  group_by(run, id) |> 
  mutate(n = n()) |> 
  ungroup() |> 
  group_by(run) |> 
  arrange(desc(n)) |>
  mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
  select(run, n, ecdf) |> 
  distinct() |> 
  ungroup()
df_count_pokemon_random_draw_mean <- df_count_pokemon_random_draw |> 
  group_by(n) |> 
  summarise(mean_ecdf = mean(ecdf))
df_count_pokemon_random_draw |> 
  # filter(run == 3) 
  ggplot(
    aes(
      x = n, 
      y = ecdf, 
      colour = run
    )
  ) +
  geom_line(aes(group = run), alpha = .01, size = .1) +
  geom_point(aes(group = run), alpha = .01, size = .1) +
  geom_line(
    data = df_count_pokemon_random_draw_mean,
    aes(y = mean_ecdf),
    colour = "red"
  ) +
  scale_x_continuous(
    limits = c(1, 130),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    limits = c(0.001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/random-draw-1000runs.png", width = 3000, height = 2000, unit = "px")

```

## まんべんなくとられているか

group_by(id) |> summariseでnrow()でかんたんにわかる。empiricalは、現時点で905全ポケモンのうち903ポケが登場したことがある。
ランダムのシミュレーションを何度もまわせば、この時点でこれくらいの数のポケモンが少なくとも一度ポケカになったということがわかるはず。そことどれくらいずれるのだろうか。

### 多様性はどうか

1年くらいのウィンドウをずらしていって、なんとかの多様性を測る。個体数とVariant数が一致しないので難しいのだが…。個体数がでればなぁ　試合なら出るか。
