# random draw

```{r}
df_series |> 
  colnames()
```

```{r}
df_game_gen <- 
  tribble(
    ~game_gen, ~game_release_date, ~game_release_date_ja, ~pokemon_n_new,
    1,         "1998-09-28",   "1996-02-27", 151,
    2,         "2000-10-15",   "1999-11-21", 100,
    3,         "2003-03-15",   "2002-11-21", 135, # https://bulbapedia.bulbagarden.net/wiki/Generation_III
    4,         "2007-04-22",   "2006-09-28", 107, # https://bulbapedia.bulbagarden.net/wiki/Generation_IV
    5,         "2011-03-04",   "2010-09-18", 156, 
    6,         "2013-10-12",   "2013-10-12", 72,
    7,         "2016-11-18",   "2016-11-18", 88, # 81+5+2=88
    8,         "2019-11-15",   "2019-11-15", 96, # 89+7
    9,         "2022-11-18",   "2022-11-18", NA_integer_
    ) |> 
  mutate(
    across(starts_with("game_release"), as.Date),
    game_end_date = lead(game_release_date),
    pokemon_cumulative_n = cumsum(pokemon_n_new)
  )
df_series2$cards_total |> na.omit() |> sum() # 15186
df_gene |> nrow() # 15029

df_series2$pokemon_data_count |> na.omit() |> sum()
# df_game_gen |> filter(game_gen == 1) |> extract("release_date") |> pull()
```


```{r}
series_gen_df <- df_series2 |> 
  select(series_gen, series, release_date, cards_total, pokemon_data_count) |> 
  distinct()
series_gen_df |> View()

series_gen_df2 <- map_dfr(
  .x = 1:8, 
  ~ mutate(
    .data = series_gen_df, 
    game_gen = 
      case_when(
        release_date < df_game_gen |> filter(game_gen == .x+1) |> extract("game_release_date") |> pull() &
        release_date > df_game_gen |> filter(game_gen == .x) |> extract("game_release_date") |> pull()
        ~ .x,
        TRUE ~ NA_integer_
      ),
    # game_gen_ja = 
    #   case_when(
    #     release_date < df_game_gen |> filter(game_gen == .x+1) |> extract("release_date_ja") |> pull() 
    #     ~ .x
    #   )
    ) |> filter(!is.na(game_gen))
  ) 
series_gen_df2
series_gen_df2 |> filter(series == "Dragon Vault")
series_gen_df2$pokemon_data_count |> na.omit() |> sum() # 15029
```

Neo Genesisは[例外的に](https://bulbapedia.bulbagarden.net/wiki/Neo_Genesis_(TCG))速いが、他は基本的に新世代の発表からちょっと遅れて？登場してそう


```{r}
df_gene |> 
  ggplot(aes(x = release_date, y = id, colour = pokemon_gen)) +
    geom_rect(
    data = df_game_gen |> filter(game_gen != 9),
    aes(xmin = game_release_date, xmax = game_end_date, fill = game_gen |> as.factor()),
    ymin = -Inf, ymax = Inf, 
    inherit.aes = FALSE,
    alpha = .5
  ) +
  geom_count(alpha = .3,  stroke = .1) +
  geom_count(data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  scale_colour_viridis_c(option = "C") +
  # scale_fill_viridis_c() +
  scale_fill_viridis_d(option = "C") +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
ggsave("./output/blackstar-promo-release-date-problem.png", width = 3000, height = 2000, unit = "px")
```

"Black Star Promo"がおかしいことがわかる。


Generationをrectじゃなくて線にしてみましょう
```{r}
df_gene |> 
  ggplot(aes(x = release_date, y = id)) +
  geom_vline(
    data = df_game_gen |> filter(game_gen != 9),
    aes(xintercept = game_release_date, colour = game_gen |> as.factor()),
    linetype = "dashed"
  ) +
  geom_text(
    data = df_game_gen |> filter(game_gen != 9),
    aes(label =as.roman(game_gen), x = game_release_date, colour = game_gen |> as.factor()),
    y = -10,
    size = 2,
    hjust = 0,
    vjust = 1,
    nudge_x = 100,
    # nudge_y = -1000
  ) +
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .3,  stroke = .1) +
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .5, data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  # scale_colour_viridis_d(option = "C") +
  scale_fill_viridis_c() +
  scale_colour_viridis_d(option = "D") +
  scale_y_continuous(limits = c(0, NA)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
ggsave("./output/blackstar-promo-release-date-problem.png", width = 3000, height = 2000, unit = "px")
```
とりあえず問題があることはわかったものの治さずともとりあえずランダムドローはできるのでやってみる。

## Random draw

ここでの目的は、株式会社ポケモンのデザイナーの思考パターンをランダムでどこまで模せるかを調べること。そのためにはいくつかのpresumptionが必要になる。まず、あるタイムステップ（具体的には`release_date`のどこか）`t = t_n`で、すでにリリースされているポケモンのゲーム・すでに公開されているポケモンのリストがあるとする。`t_n`においてリリースする枚数は興味がないので、すでに決定しているとする（`release_date`における`total_cards`に相当する）。そのとき、デザイナーは次のように適当にポケモンを選ぶことが考えられる：

1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を許す。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複をなるべく避ける（その回にすでにひいたポケモンにネガティブなバイアスがかかる）。毎回のリリースで偏りが生じる。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶ。重複を好む（すでにひいたポケモンにポジティブなバイアスがかかる）
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、そのとき`t_n`が最も最近（頭痛が痛い…）の`game_release_date`に近い場合、新しく追加されたポケモンを好んで選ぶ（新しいポケモンの発表直後はどうも多くリリースされているように見えるので）。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶのだが、Generation Iの151匹から好んで選ぶ。第1世代へポジティブなバイアス。やっぱり人気だから…イーブイとかピカチュウとか…。
1. すでに発表されているポケモンのプールの中からランダムに枚数ぶん選ぶするのだが、今までのリリースで多く選ばれたものを好んで選ぶ。正の頻度依存バイアス。

これだけあればとりあえず十分かと・・・。まず１だけ実装してみよう。
nested dfでやるかmatrixでやるかはたまたdfでやるか。毎回population_sizeが違うのでnested dfがいいのかな


```{r}
series_gen_df3 <- series_gen_df2 |> 
  left_join(df_game_gen |> select(game_gen, pokemon_cumulative_n), by = "game_gen") |> 
  filter(!is.na(pokemon_data_count))
series_gen_df3
```
[Unnest a list of vectors in a data frame in R](https://stackoverflow.com/questions/66819613/unnest-a-list-of-vectors-in-a-data-frame-in-r)
```{r}

sim_random_df_small <- tibble(
  series_gen = integer(),
  series = character(),
  release_date = Date(),
  cards_total = integer(),
  pokemon_data_count = integer(),
  game_gen = integer(),
  pokemon_cumulative_n = integer(),
  id = integer(), 
  run = integer()
)
simulation_runs <- 10

for (simulation_run in 1:simulation_runs) {
  single_sim_result_df <- series_gen_df3 |>
  mutate(
    id =  map2( # rowwise() does not work...?
      .x = pokemon_data_count,
      .y = pokemon_cumulative_n,
      ~ runif(
        n = .x,
        min = 1,
        max = .y + 1
      ) |> floor()
    ),
    run = rep(simulation_run, nrow(series_gen_df3))
  ) |> 
  unnest_longer(id)
  sim_random_df_small <- bind_rows(sim_random_df_small, single_sim_result_df)
} # .5sec for 1000 runs
```
### unnest now


```{r}

sim_random_df |> colnames()
sim_random_df |> dim() # 1000 runs, 15million rows
```
### frequency distribution of 1000 runs

```{r}
df_count_pokemon_random_draw <- sim_random_df |> 
  group_by(run, id) |> 
  mutate(n = n()) |> 
  ungroup() |> 
  group_by(run) |> 
  arrange(desc(n)) |>
  mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
  select(run, n, ecdf) |> 
  distinct() |> 
  ungroup()
df_count_pokemon_random_draw_mean <- df_count_pokemon_random_draw |> 
  group_by(n) |> 
  summarise(mean_ecdf = mean(ecdf))
df_count_pokemon_random_draw |> 
  # filter(run == 3) 
  ggplot(
    aes(
      x = n, 
      y = ecdf
    )
  ) +
  geom_line(aes(group = run), alpha = .01, size = .1) +
  geom_point(aes(group = run), alpha = .01, size = .1) +
  geom_line(
    data = df_count_pokemon_random_draw_mean,
    aes(y = mean_ecdf),
    colour = "red"
  ) +
  scale_x_continuous(
    limits = c(1, 130),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    limits = c(0.001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/random-draw-1000runs.png", width = 3000, height = 2000, unit = "px")

```
### compare with empirical data

```{r}
df_count_pokemon_random_draw # simulation 
df_count_pokemon # empirical
df1 <- df_count_pokemon_random_draw %>%
  mutate(condition = rep("simulation", nrow(x = .)))
df2 <- df_count_pokemon %>%
  mutate(condition = rep("empirical", nrow(x = .)))
df_compare_empirical_simulation1 <- bind_rows(df1, df2)

df_compare_empirical_simulation1 |> 
    ggplot(
    aes(
      x = n, 
      y = ecdf,
      colour = condition
    )
  ) +
  geom_point() +
  scale_x_continuous(
    # limits = c(1, 130),
    trans = "log10",
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    # limits = c(0.001, 1),
    trans = "log10",
    breaks = 10^(0:-10)
    ) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )



```

### compare gen histogram 

```{r}
df_empirical_count_id <- 
  df_gene |> 
  filter(!is.na(id)) |> # filter only pokemons. is_
  group_by(id) |> 
  summarise(n = n()) %>% 
  mutate(
    condition = rep("empirical", nrow(.))
  )
random_draw_df2_gen <- 
  random_draw_df2 |> 
  left_join(df_names, by = "id") |> 
  group_by(id) |> 
  summarise(n = n()) %>%
  mutate(
    condition = rep("simulation", nrow(.))
  )
bind_rows(df_empirical_count_id, random_draw_df2_gen) |>
  ggplot(aes(x = id, y = n, colour = condition)) +
  geom_point(alpha = .3) 
```
### まんべんなくとられているか

nrow()でかんたんにわかる。empiricalは、現時点で905全ポケモンのうち903ポケが登場したことがある。
ランダムのシミュレーションを何度もまわせば、この時点でこれくらいの数のポケモンが少なくとも一度ポケカになったということがわかるはず。そことどれくらいずれるのだろうか。

### 多様性はどうか

1年くらいのウィンドウをずらしていって、なんとかの多様性を測る。個体数とVariant数が一致しないので難しいのだが…。個体数がでればなぁ　試合なら出るか。

### plot ~ t

```{r}
random_draw_df2 |> 
  ggplot(aes(x = release_date, y = id)) +
  geom_vline(
    data = df_game_gen |> filter(game_gen != 9),
    aes(xintercept = game_release_date, colour = game_gen |> as.factor()),
    linetype = "dashed"
  ) +
  geom_text(
    data = df_game_gen |> filter(game_gen != 9),
    aes(label =as.roman(game_gen), x = game_release_date, colour = game_gen |> as.factor()),
    y = -10,
    size = 2,
    hjust = 0,
    vjust = 1,
    nudge_x = 100,
    # nudge_y = -1000
  ) +
  geom_count( alpha = .3,  stroke = .1)
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .3,  stroke = .1) +
  geom_count(aes( fill = pokemon_gen), pch = 21, alpha = .5, data = df_gene |> filter(series_class == "Black Star Promo"), colour = "black") +
  # scale_colour_viridis_d(option = "C") +
  scale_fill_viridis_c() +
  scale_colour_viridis_d(option = "D") +
  scale_y_continuous(limits = c(0, NA)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    axis.line = element_line(size = .3),
    axis.ticks = element_line(size = .1),
    plot.background = element_rect(fill = "white")
  )
```

## temporal change over time


10simとNameとpokemon_nameの推移を並べて、`release_date`ごとにどう変わっていったかをアニメーションにしてみる。
{gganimate}は使えない気がするので、地味にpngで連番でだすかなぁ

と思ったが、やっぱり毎月などの等間隔のほうがいい気がしてきた。

```{r}
release_dates <- df_series2 |> 
  filter(!is.na(pokemon_data_count)) |> 
  select(release_date) |> 
  na.omit() |> 
# number_of_releases <- length(release_dates) # 148
release_dates |> min() # 1999 Jan
release_dates |> max()# 2022 Sep
# months_seq <- seq(as.Date("2009-01-01"), length = 166, by = "months")
years_seq <- seq(as.Date("2010-01-01"), length = 14, by = "years")
```

この`release_dates`で`for`を回して、これ以下のデータでフィルタしていく。


### temporal change, cumulative

```{r}
sim_random_df_small # 10 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 

# initialize
temporal_change_cumulative_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  until_date = Date()
)
# run length(months_seq)
for (i in 1:length(years_seq)) {
  sim_random_df_small_until_threshold_date <-
    sim_random_df_small |> 
    filter(release_date <= years_seq[i])
  emp_df_until_threshold_date <- df_gene |> 
    filter(!is.na(id)) |> 
    filter(release_date <= years_seq[i])
  
  sim_df <- 
    sim_random_df_small_until_threshold_date |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_long_df <- 
    emp_df_until_threshold_date |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_until_threshold_date |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_long_df, emp_poke_df) %>%
    mutate(
      until_date = rep(years_seq[i], nrow(.))
    )
  temporal_change_cumulative_df <- bind_rows(temporal_change_cumulative_df, merge_df)
} # 3 sec
temporal_change_cumulative_df |> dim() # 6151 x 5

```

plot

```{r}
temporal_change_cumulative_df |> 
  ggplot(aes(x = n,y = ecdf, group = paste(until_date, run), colour = until_date)) +
  geom_line(alpha = 1, size = 1) +
  # geom_point( alpha = 1, size = .1) +
  scale_x_continuous(
     expand = c(0,0),
    # limits = c(1, 10000),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    expand = c(0,0),
    # limits = c(0.0001, 1),
    trans = "log10", 
    breaks = 10^c(0, -3),
    labels = trans_format("log10", math_format(10^.x))
    ) +
  scale_colour_viridis_c(trans = "date") + 
  facet_wrap(vars(condition)) +
  # facet_grid(
  #   rows = vars(until_date),
  #   cols = vars(condition)
  # ) +
  theme_minimal(base_size = 64) +
  theme(
    panel.grid = element_blank(),
    legend.position = "none",
    # panel.background = element_rect(size = .4),
    axis.line = element_line(
      size = .1/.751
      ),
    axis.text = element_text(size = 6),
    axis.ticks = element_line(),
    aspect.ratio = 1,
    plot.background = element_rect(fill = "white", colour = NA)
  )
ggsave("./output/temporal-change-cumulative.png", width = 150, height = 75, unit = "mm", dpi = 600)
ggsave("./output/temporal-change-cumulative.pdf", width = 250, height = 250, unit = "mm")
ggsave("./output/temporal-change-cumulative.svg", width = 250, height = 250, unit = "mm")

```
### temporal change, yearly
### temporal change, cumulative

```{r}
sim_random_df_small # 10 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 

# initialize
temporal_change_cumulative_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  until_date = Date()
)
# run length(months_seq)
for (i in 1:length(months_seq)) {
  sim_random_df_small_until_threshold_date <-
    sim_random_df_small |> 
    filter(release_date < months_seq[i])
  emp_df_until_threshold_date <- df_gene |> 
    filter(!is.na(id)) |> 
    filter(release_date < months_seq[i])
  
  sim_df <- 
    sim_random_df_small_until_threshold_date |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_long_df <- 
    emp_df_until_threshold_date |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_until_threshold_date |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_long_df, emp_poke_df) %>%
    mutate(
      until_date = rep(months_seq[i], nrow(.))
    )
  temporal_change_cumulative_df <- bind_rows(temporal_change_cumulative_df, merge_df)
} # 1min?
temporal_change_cumulative_df |> dim() # 71780 x 5

```

plot

```{r}
temporal_change_cumulative_df |> 
  ggplot(aes(x = n,y = ecdf, group = until_date, colour = until_date)) +

  geom_line(alpha = 1, size = .1) +
  geom_point( alpha = 1, size = .1) +
  scale_x_continuous(
    # limits = c(1, 10000),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    # limits = c(0.0001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  scale_colour_viridis_c() + 
  facet_wrap(vars(condition)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/temporal-change-cumulative.png", width = 6000, height = 2000, unit = "px")

```

### temporal change, temporal

```{r}
sim_random_df_small # 10 runs
df_gene # `Name` = group by distinct names, `pokemon_name` = group by distinct pokemons. 

# initialize
temporal_change_each_release_df <- tibble(
  n = integer(),
  ecdf = double(),
  run = integer(),
  release_date = Date()
)
# run length(months_seq)
for (i in 1:length(release_dates)) {
  sim_random_df_small_each_release <-
    sim_random_df_small |> 
    filter(release_date == release_dates[i])
  emp_df_each_release <- df_gene |> 
    filter(!is.na(id)) |> 
    filter(release_date == release_dates[i])
  
  sim_df <- 
    sim_random_df_small_each_release |> 
    group_by(run, id) |> 
    mutate(n = n()) |> 
    ungroup() |> 
    group_by(run) |> 
    arrange(desc(n)) |>
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |> 
    select(run, n, ecdf) |> 
    distinct() |> 
    ungroup() %>%
    mutate(
      condition = rep("simulations", nrow(.))
    )
  emp_long_df <- 
    emp_df_each_release |> 
    group_by(Name) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-Name) |> 
    distinct() %>%
    mutate(condition = rep("card name", nrow(.)))
  emp_poke_df <- 
    emp_df_each_release |> 
    group_by(id) |> 
    summarise(n = n()) |> 
    arrange(desc(n)) |> 
    mutate(ecdf = 1 - ecdf(n)(n - .01)) |>
    select(-id) |> 
    distinct() %>%
    mutate(condition = rep("pokemon name", nrow(.)))
  merge_df <- bind_rows(sim_df, emp_long_df, emp_poke_df) %>%
    mutate(
      release_date = rep(release_dates[i], nrow(.))
    )
  cat(i, ", ")
  temporal_change_each_release_df <- bind_rows(temporal_change_each_release_df, merge_df)
} # 1min?
temporal_change_each_release_df |> dim() # 71780 x 5

```

plot

```{r}
temporal_change_each_release_df |> 
  ggplot(aes(x = n,y = ecdf, group = paste(release_date, run), colour = release_date)) +

  geom_line(alpha = 1, size = .1) +
  geom_point( alpha = 1, size = .1) +
  scale_x_continuous(
    # limits = c(1, 10000),
    trans = "log10", 
    breaks = 10^(0:10)
  ) +
  scale_y_continuous(
    # limits = c(0.0001, 1),
    trans = "log10", 
    breaks = 10^(0:-10)
    ) +
  scale_colour_viridis_c() + 
  facet_wrap(vars(condition)) +
  theme_minimal() +
  theme(
    panel.grid = element_blank(),
    panel.background = element_rect(size = .3),
    axis.ticks = element_line(size = .1),
    aspect.ratio = 1
  )
ggsave("./output/temporal-change-each_release.png", width = 6000, height = 2000, unit = "px")

```

### try {gganimate}


[gganimate](https://gganimate.com/)
```{r}


# # +
#   transition_states(
#     until_date
#   )  +
```

