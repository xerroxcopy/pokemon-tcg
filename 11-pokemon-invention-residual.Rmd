# residual

Growth Rate in Newberry & Plotkin (2022)に代わるものとして、インターバルを計算できないだろうか。
あるポケモン（なんでもいいのでなにかを想像）のカードが発売されたとして、次また登場するのはいつか？
Timestepではなく時間のデータもあるのもなにかに使えるかも。とくに何百枚もリリースされるメインとMcDonaldsとかを一緒に扱うのは少し気が引ける。
その時点で500種のポケモンが発表されていたとしよう。デザインをランダムで決めていたとすると、次の125枚のリリースで少なくとも一枚登場する確率は…

```{r}
1 - (499/500)^125 # .221
```
22%くらい。そもそも種数にもかなり乖離がありそう。

```{r}
sim_random_df 
```
150万行あるので注意しましょう…。
とりあえず種数を計算してみましょう。簡単そうだから。
累積種数（一度以上登場したことのあるポケモンの数~ｔ）と、そのときどきの種数をEmpiricalからやってみる。そのときどきを計算すればそれをcumsumするのはラクそう。

## cumulative

### empirical

#### prepare df for plot

```{r}
df_first_seen <- df_first_last_seen |> 
  filter(!is.na(id)) |> 
  select(id, first_and_last, pokemon_name, release_date) |> # temporally simplify df
  filter(first_and_last == "Debut") |> 
  distinct() |> # 902, 2 absent still as of today
  ungroup() |> 
  arrange(release_date) %>%
  mutate(
    onek = rep(1, nrow(.)),
    cumsum = cumsum(onek),
    onek = NULL
    )
```

#### plot

```{r}
df_first_seen |> 
  ggplot(aes(x = release_date, y = cumsum)) +
  geom_line()
```

### sim
```{r}
sim_random_df |> colnames()
```
#### flag Debut & Last Seen for a random sim run
```{r}
sim_random_df_first_last_seen <- sim_random_df |> 
  # filter(run <= 10) |> 
  group_by(run, id) |> 
  mutate(
    first_and_last = case_when(
      release_date == min(release_date) ~ "Debut",
      release_date == max(release_date) ~ "Last Seen",
      TRUE ~ "Inbetween"
    )
  )


  
```
TODO: これでoverviewと同じプロットをしないとね(右上

#### prepare df for plot

```{r}
sim_random_df_first_seen <- sim_random_df_first_last_seen　|> 
  select(id, run, first_and_last, release_date) |> # temporally simplify df
  filter(first_and_last == "Debut") |> 
  distinct() |> 
  ungroup() %>%
  mutate(onek = rep(1, nrow(.))) |> 
  group_by(run) |>
  arrange(release_date) |> 
  mutate(
    cumsum = cumsum(onek),
    onek = NULL
  )
```

#### plot
論文掲載予定（ちっちゃく、下の残差プロットと並べて）
```{r}
p_sim_emp_debut_cumsum <- sim_random_df_first_seen |> 
  ggplot(aes(x = release_date, y = cumsum)) +
  geom_vline(
    data = df_game_gen |> filter(game_gen != 9),
    aes(xintercept = game_release_date),
        colour = "grey80",
    # linetype = "dotted",
    size = .05/.751
  ) +
  geom_hline(
    data = df_game_gen,
    aes(yintercept = pokemon_cumulative_n),
    size = .05/.751,
    colour = "grey80"
  ) +
  geom_line(
    aes(group = run),
    alpha = .1
  ) +
  geom_line(
    data = df_first_seen,
    colour = "orange",
    ) +
  scale_x_date(
    breaks = c(as.Date("2000-01-01"),as.Date("2010-01-01"),as.Date("2020-01-01")),
    labels = c("", "", ""),
    expand = c(.01, .01),
    name = NULL
  ) +
  scale_y_continuous(
    breaks = c(0, 500, 1000),
    labels = c(0, "", 1000),
    limits = c(0, 1000),
    name = "Total Debutant"
  ) +
  theme_pokemon
```
### residual plot

```{r}
sim_random_df_first_seen # sim
df_first_seen # emp
```
この差をそれぞれのrelease_dateについてとりたい。

[fill()](https://tidyr.tidyverse.org/reference/fill.html)かなにかを使ってまずは全tickにデータを入れる必要がある気が

```{r}
df_debut_emp <-df_first_seen |> 
  group_by(release_date) |> 
  mutate(cumsum = max(cumsum)) |> 
  select(release_date, cumsum) |> 
  ungroup() |> 
  distinct() |> 
  right_join(
    tibble(release_date = release_dates |> as_date()),
    by = "release_date"
  ) |> 
  arrange(release_date) |> 
  fill(cumsum, .direction = "down")
```
```{r}
df_debut_sim <-sim_random_df_first_seen |> 
  group_by(release_date, run) |>
  mutate(cumsum = max(cumsum)) |> 
  select(release_date, cumsum, run) |> 
  ungroup() |> 
  distinct() |> 
  right_join(
    tibble(release_date = release_dates |> as_date()),
    by = "release_date"
  ) |> 
  group_by(run) |> 
  arrange(release_date) |> 
  fill(cumsum, .direction = "down") |> 
  ungroup()

# merge them
df_debut_sim_emp <- df_debut_sim |> 
  left_join(df_debut_emp, by = "release_date") |> 
  rename(cumsum_sim = cumsum.x, cumsum_emp = cumsum.y) |> 
  mutate(residual = cumsum_sim - cumsum_emp) # どっちからどっちひけばいいのかもはやわからん…疲れた…

```


#### plot the residual ~ t
95%信頼？信頼…？信用…？区間…？と０がかぶってるかどうかで色付けしたいね。そんなことしていいんかな

```{r}
p_sim_emp_debut_residual <- df_debut_sim_emp |> 
  ggplot(aes(x = release_date, y = residual, group = release_date)) +
  geom_hline(yintercept = 0, colour = "grey80") +
   geom_vline(
    data = df_game_gen |> filter(game_gen != 9),
    aes(xintercept = game_release_date),
        colour = "grey80",
    # linetype = "dotted",
    size = .05/.751
  ) +
  geom_quasirandom(groupOnX = TRUE, size = .1, alpha = .5, width = 50) +
  scale_x_date(
    breaks = c(as.Date("2000-01-01"),as.Date("2010-01-01"),as.Date("2020-01-01")),
    labels = c(2000, "", 2020),
    expand = c(.01, .01),
    name = "Year"
  ) +
  scale_y_continuous(
    breaks= c(-100, 0, 100),
    name = "Residual, Sim - Empirical Data",
  ) +
  theme_pokemon

```

