# UMAP 

```{r}
library(uwot) # package {umap} does not allow metric input of categorical
df_gene |> colnames()
```

## make all available genes into true/false or quantitative data
```{r}
# interval(df_gene$release_date[1], df_gene$release_date[2400]) |> 
  # int_length()

umap_input_factor <- df_gene |> 
  filter(!is.na(id)) |> 
  mutate(
    seconds_since_first_release =
      interval(release_date |> min(), release_date) |> int_length(),
    is_secret_card = replace_na(is_secret_card, FALSE),
    time_since_first_release_standardized = seconds_since_first_release / seconds_since_first_release |> max(),
    master = replace_na(master, "no_master"),
    forme_variant = replace_na(forme_variant, "no_forme_variant")
  ) |> 
  select(time_since_first_release_standardized, pokemon_gen, id, Type2, series, is_secret_card, series_class, is_gx:forme_variant) |> # ayashii: series
  mutate(
    across(Type2:forme_variant, ~as.factor(.x)),
    across(pokemon_gen:id, ~as.numeric(.x))
  )
umap_input_factor
```


```{r}
umap_input_data <- df_gene |> 
  
  filter(!is.na(id)) |> 
  mutate(
    seconds_since_first_release =
      interval(release_date |> min(), release_date) |> int_length(),
    time_since_first_release_standardized = seconds_since_first_release / seconds_since_first_release |> max()
  ) %>%
  # select(Type2, master, forme_variant) |> 
  mutate(
    master = replace_na(master, "no_master"),
    forme_variant = replace_na(forme_variant, "no_forme_variant")
  ) |> 
  # mutate(Type2 = as.factor(Type2)) %>%
  rowid_to_column() %>%
  mutate(
    T_Type2 = rep(1, nrow(.)),
    T_forme_variant = rep(1, nrow(.)),
    T_master = rep(1, nrow(.))
  ) |>  
  pivot_wider(
    names_from = Type2,
    values_from = T_Type2,
    values_fill = 0
  ) |> 
  pivot_wider(
    names_from = master,
    values_from = T_master,
    values_fill = 0
  ) |> 
  pivot_wider(
    names_from = forme_variant,
    values_from = T_forme_variant,
    values_fill = 0
  ) |> 
  mutate(
    standardized_id = id / max(id), 
    # across(starts_with("is_"), ~ if_else(.x, 1, 0)),
    # across(starts_with("has_"), ~ if_else(.x, 1, 0)),
    is_secret_card = replace_na(is_secret_card, 0),
    seconds_since_first_release = NULL,
    Type = NULL,
    master = NULL,
    forme_var
    )
View(umap_input_data)
umap_input_data2 <- 
  umap_input_data |> 
  select(time_since_first_release_standardized, pokemon_gen, is_gx:standardized_id)
View(umap_input_data2)
umap_input_data2 |> dim() # 12724 x 145
# above_20 <- umap_input_data2 |> 
#   summarise(across(everything(), ~sum(.x))) |> 
#   pivot_longer(cols = everything()) |> 
#   filter(value > 30) %>% .$name
# umap_input_data3 <- umap_input_data2 |> 
#   select(time_since_first_release_standardized, standardized_id, pokemon_gen, one_of(above_20))
```

## run UMAP

[uwot](https://github.com/jlmelville/uwot) mate
```{r}
pokemon_umap <- umap_input_data2 |> 
  umap(
    verbose = TRUE, 
    min_dist = 0.5,
    n_neighbors = 40,
    n_threads = 6)
```

### factor

https://www.rdocumentation.org/packages/uwot/versions/0.1.11/topics/umap
{uwot}'s `uwot::umap()` does not accept tibble. convert it to data.frame
```{r}
umap_input_factor_cols <- umap_input_factor |> colnames()

pokemon_umap_factor <- umap_input_factor |> 
  as.data.frame() |> 
  uwot::umap(verbose = TRUE, 
    nn_method = "annoy",
    # min_dist = 0.5,
    # n_neighbors = 40,
    n_threads = 6,
    metric = list("euclidean" = umap_input_factor_cols[1:3],
                  "categorical" = umap_input_factor_cols[4:42])
  )

```

## prepare plot df

```{r}
pokemon_umap_df <- pokemon_umap$layout |> 
  as_tibble() |> 
  rename(x = V1, y = V2) |> 
  rowid_to_column() |> 
  left_join(umap_input_data, by = "rowid")
View(pokemon_umap_df)
pokemon_umap_factor_df <- pokemon_umap_factor |> 
  as_tibble() |> 
  rename(x = V1, y = V2) |> 
  rowid_to_column() |> 
  left_join(umap_input_data, by = "rowid")

```
## plot

```{r}
pokemon_umap_df |> colnames()
pokemon_umap_factor_df |> 
  ggplot(aes(x = x, y = y, colour = id)) +
  geom_jitter(size = .3, alpha = .1) +
  geom_text(
    # data = pokemon_umap_df |> filter(x > 30 | y > 30),
    aes(label = paste(series_abb, "_", Name)),
    size = .7,
    max.overlaps = Inf,
    force = .2,
    force_pull = 2,
    segment.size = .05
    ) +
  scale_colour_viridis_c() +
  theme_pokemon
ggsave("./output/emp_umap_factor_id.svg", width = 300, height = 300, unit = "mm")
```
```{r}
pokemon_umap_df |> 
  filter(x > 300)
```


